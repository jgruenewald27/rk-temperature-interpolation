---
title: "Test_kriging"
author: "Johannes Gruenewald"
date: "2024-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Databasis for this code is: https://pages.cms.hu-berlin.de/EOL/gcg_quantitative-methods/Lab14_Kriging.html
This is just a test run to get familiar with coding in R and how to run the basic steps which are necessary for a successful interpolation.

```{r}
#install.packages("mapview")

library("gstat")   # geostatistics
library("mapview") # map plot
library("sf")      # spatial vector data
library("stars")   # spatial-temporal data
library("terra")   # raster data handling 
library("ggplot2") # plotting
library("tidyverse")
library("dplyr")
library("sp")
mapviewOptions(fgb = FALSE)
```

```{r}
# Read temperature points
temp <- read_sf('../data/sensor_data_20240107_31days.gpkg')

temp
```

Preprocessing temperature data
```{r}
temp <- temp[!is.na(temp$temperature), ]  # Removes only rows where `temperature` is NA

# Calculate the monthly mean temperature for each station, keeping only July (month 7)
july_mean_temp <- temp %>%
  filter(format(dateobserved, "%m") == "07") %>%  # Filter only July
  group_by(stationname, year = format(dateobserved, "%Y")) %>%  # Group by station and year
  summarise(mean_temperature = mean(temperature, na.rm = TRUE), .groups = "drop")  # Calculate mean temperature

# View the result
july_mean_temp


# Filter by specific date (ignoring the time)
#temp_subset <- temp %>% filter(format(`dateobserved`, "%Y-%m-%d") == '2023-07-08')

#temp_subset
```

```{r}
# Plot measurement stations
mapview(temp['temperature'])
```

Load AOI
```{r}
aoi_grid <- read_stars("../data/canopy_height_hd_mannheim_1m.tif")
aoi_grid
```


Create a grid

```{r}
bbox <- st_bbox(temp)
bbox

cell_size <- 10

x <- seq(bbox$xmin, bbox$xmax, by=cell_size)
y <- seq(bbox$ymin, bbox$ymax, by=cell_size)

temp_grid <- expand.grid(x=x, y=y)
plot(temp_grid$x, temp_grid$y, pch=19, cex=0.1)

temp_grid$tmp <- 1
temp_grid <- st_as_stars(temp_grid, crs=st_crs(temp))
st_crs(temp_grid) <- st_crs(temp) # re-assign crs to be safe
```

IDW Interpolation

```{r}
# Remove rows with NA in 'temperature'
temp_subset <- temp_subset[!is.na(temp_subset$temperature), ]

temp.idw <- gstat::idw(temperature ~ 1, locations=temp, newdata=temp_grid, idp = 2)
```

```{r}
temp.idw
```

Plot the predictions

```{r}
plot(rast(temp.idw["var1.pred"]))
plot(temp["temperature"], col=1, cex=0.5, add=T, type="p")
```

Sample Variogram

```{r}
temp.v <- gstat::variogram(log(temperature) ~ 1, temp_subset)
plot(temp.v, ylab=bquote(gamma), xlab=c("h (separation distance in m)"))
```

Direction dependence

```{r}
plot(variogram(log(temperature) ~ 1, temp_subset, alpha = c(0, 45, + 90, 135)))
```

Fit a variogram

```{r}
temp.sph <- vgm(psill=0.011, "Lin", range=15, nugget=0.008)
plot(temp.v, temp.sph, cutoff=4)
```

Fit variogram

```{r}
temp.vfit <- fit.variogram(temp.v, temp.sph)
temp.vfit
```

```{r}
plot(temp.v, temp.vfit)
```

Ordinary kriging

```{r}
# create sample variogram
#temp.v <- gstat::variogram(log(temperature) ~ 1, temp)

# fit variogram model
#temp.vfit <- gstat::fit.variogram(temp.v, vgm(0.03, "Sph", 3, 0.0002))

# ordinary kriging
lz.ok <- gstat::krige(log(temperature) ~ 1, temp_subset, temp_grid, temp.vfit)
```

Plot results of ordinary kriging

```{r}
plot(rast(lz.ok['var1.pred']))
plot(temp["temperature"], col="blue", cex=0.5, type="p", add=T)
```

Plot variance values of ordinary kriging

```{r}
plot(rast(lz.ok['var1.var']))
plot(temp["temperature"], col="blue", cex=0.5, type="p", add=T)
```

Universal kriging includes other covariates to account for potential trends

```{r}
elev <- terra::rast("../data/hd_elev.tif")
lcz <- terra::rast("../data/lcz_08012024.tif")
```

```{r}
elev <- terra::project(elev,"EPSG:4326")
crs(elev)

lcz <- terra::project(lcz,"EPSG:4326")
crs(lcz)
```

```{r}
plot(lcz["lcz"])
```

```{r}
temp <- temp %>% 
  filter(!is.na(temperature)) %>%
  group_by(entity_id) %>%
  slice_max(order_by = dateobserved, n = 1) %>% 
  dplyr::select(c(temperature))
```

```{r}
# Add X Y Coordinates to data_temp This is necessary for later steps
temp$X <- st_coordinates(temp)[,1]
temp$Y <- st_coordinates(temp)[,2]
```

```{r}
# get elevation at the sites
elevation <- terra::extract(elev,
                             temp,
                             buffer=0)
```

```{r}
# unlist elevations to add as column to data
temp$elevation <- elevation[,2]
```

```{r}
# Load SpatRaster using terra
lcz <- read_stars("../data/lcz_08012024.tif")  

lcz <- split(lcz, "lcz_08012024")
lcz
```


```{r}
lz.uk <- krige(log(temperature) ~ sqrt(elevation), locations=temp_subset, 
                                       newdata=temp, 
                                       model=temp.vfit)
```

