---
title: "Experiment with LCZ"
author: "Johannes Gruenewald"
date: "2024-12-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Check if there is a correlation between Local Climate Zones and temperature information. LCZ information could be an interesting additional input parameter as it could help to explain the influence of changes in land use/land cover and this relationship to temperature changes.

This R script explores this relationship between the two.

```{r}
library(sf)
library(geojsonsf)
library(terra)
library(sp)
library(gstat)
library(tidyverse)
library(ggplot2)
```

```{r}
lcz <- terra::rast("../data/lcz_08012024.tif")
data_temp <- st_read("../data/sensor_data_20240107_31days.gpkg")
```

```{r}
# Reproject LCZ
lcz <- terra::project(lcz,"EPSG:32632")

# Reproject temperature data
data_temp <- st_transform(data_temp, crs = 32632)

# Check if CRS match and print both CRS
if (st_crs(data_temp) == crs(lcz)) {
  print("CRS match: Both datasets are in the same coordinate reference system.")
} else {
  print("CRS mismatch: The datasets have different coordinate reference systems.")
}

# Print the actual CRS of both datasets
print(paste("Temperature Data CRS:", st_crs(data_temp)$input))
print(paste("LCZ CRS:", crs(lcz)))
```

Clean the temperature data

```{r}
# clean the data and convert into correct data format
data_temp_clean <- data_temp %>%
  filter(!is.na(temperature))

data_temp_clean$dateobserved <- as.Date(data_temp_clean$dateobserved)
data_temp_clean$temperature <- as.numeric(data_temp_clean$temperature)
```

Explore temperature data

```{r}
# create a daily mean for each station
data_temp_daily <- data_temp_clean %>%
  group_by(stationname, dateobserved) %>%
  summarise(daily_avg_temp = mean(temperature, na.rm = TRUE), .groups = "drop")
```

```{r}
# create a weekly mean for each station
data_temp_weekly <- data_temp_clean %>%
  mutate(week = week(dateobserved), year = year(dateobserved)) %>%
  group_by(stationname, year, week) %>%
  summarise(weekly_avg_temp = mean(temperature, na.rm = TRUE), .groups = "drop")
```

For working with the LCZ data we need the information at the location of the corresponding measurement station.

```{r}
# Extract LCZ values at measurement points
data_temp_weekly$lcz_number <- terra::extract(lcz, data_temp_weekly)

# Check if LCZ values were correctly assigned
head(data_temp_weekly)
```

```{r}
# Add X Y Coordinates to data_temp This is necessary for later steps
data_temp_weekly$X <- st_coordinates(data_temp_weekly)[,1]
data_temp_weekly$Y <- st_coordinates(data_temp_weekly)[,2]
```

```{r}
# get lcz at the sites
lcz_number <- terra::extract(lcz, data_temp_weekly, buffer=0)
```

```{r}
# unlist lcz to add as column to data
data_temp_weekly$lcz_number <- lcz_number[,2]
```

```{r}
# Ensure the columns exist in the sf object
if("weekly_avg_temp" %in% colnames(data_temp_weekly) & "lcz_number" %in% colnames(data_temp_weekly)) {
  # Create the scatter plot with swapped axes
  ggplot(data_temp_weekly, aes(x = lcz_number, y = weekly_avg_temp)) +
    geom_point(color = "blue", alpha = 0.7) + # Scatter points
    geom_smooth(method = "lm", color = "red", se = TRUE) + # Linear regression line
    labs(
      title = "Correlation Between Temperature and LCZ",
      x = "LCZ",
      y = "Temperature (Â°C)"
    ) +
    theme_minimal() # Clean and modern theme
} else {
  print("The columns 'temperature' and 'lcz_number' are not found in the sf object.")
}
```

```{r}
# Ensure the required columns exist in the dataset
if("temperature" %in% colnames(data_temp) & "lcz_number" %in% colnames(data_temp)) {
  
  # Pearson Correlation
  pearson_corr <- cor(data_temp$temperature, data_temp$lcz_number, method = "pearson", use = "complete.obs")
  
  # Spearman Correlation
  spearman_corr <- cor(data_temp$temperature, data_temp$lcz_number, method = "spearman", use = "complete.obs")
  
  # Linear Regression Model
  lm_model <- lm(temperature ~ lcz_number, data = data_temp)
  
  # R-squared value
  r_squared <- summary(lm_model)$r.squared
  
  # Correlation significance test (p-value)
  correlation_test <- cor.test(data_temp$temperature, data_temp$lcz_number, method = "pearson")
  p_value <- correlation_test$p.value
  
  # Print results
  print(paste("Pearson Correlation:", round(pearson_corr, 3)))
  print(paste("Spearman Correlation:", round(spearman_corr, 3)))
  print(paste("R-squared from Linear Regression:", round(r_squared, 3)))
  print(paste("P-value:", round(p_value, 5)))
  
} else {
  print("The columns 'temperature' and 'elevation' are not found in the sf object.")
}
```
